#!/usr/bin/env bash

# Simplified setup script for Fizzy without SaaS or MySQL-specific steps
# and with automatic dependency installation removed.

set -eo pipefail

# Prefer app executables
app_root="$(
  cd "$(dirname "$0")/.."
  pwd
)"
export PATH="$app_root/bin:$PATH"

step() {
  local step_name="$1"
  shift

  echo -e "\033[1;35mâ–¸ $step_name\033[0m"
  echo -e "\033[0;90m$*\033[0m"

  "$@"

  local exit_code=$?
  echo
  return $exit_code
}

needs_seeding() {
  if [ "$CI" != "" ]; then
    return 1
  fi

  has_data=$(bin/rails runner "pp Account.all.any?" 2>/dev/null)
  if [ "$has_data" = "true" ] ; then
    return 1
  else
    return 0
  fi
}

echo
echo -e "\033[0;96m   Ëš âˆ˜             âˆ˜ Ëš   \033[0m"
echo -e "\033[1;34m  âˆ˜ËšË³Â°âˆ˜Â°  ğ’»ğ’¾ğ“ğ“ğ“  Â°âˆ˜Â°Ë³Ëšâˆ˜  \033[0m"
echo

bundle config set --local auto_install true
step "Installing RubyGems" bundle install

if [[ $* == *--reset* ]]; then
  step "Resetting the database" rails db:reset
else
  step "Preparing the database" rails db:prepare

  if needs_seeding; then
    step "Seeding the database" rails db:seed
  fi
fi

step "Cleaning up logs and tempfiles" rails log:clear tmp:clear

echo -e "\033[1;32mâœ“ Done (${SECONDS} sec)\033[0m"
